{"version":3,"file":"entities.js","sourceRoot":"","sources":["entities.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2020-2022 OnFinality Limited authors & contributors\n// SPDX-License-Identifier: Apache-2.0\n\nimport assert from 'assert';\nimport {getTypeByScalarName} from '@subql/common';\nimport {\n  assertListType,\n  getDirectiveValues,\n  getNullableType,\n  GraphQLEnumType,\n  GraphQLField,\n  GraphQLNamedType,\n  GraphQLObjectType,\n  GraphQLOutputType,\n  GraphQLSchema,\n  isEnumType,\n  isInterfaceType,\n  isListType,\n  isNonNullType,\n  isObjectType,\n  isUnionType,\n} from 'graphql';\nimport {DirectiveName} from './constant';\nimport {buildSchemaFromFile} from './schema';\nimport {\n  FieldScalar,\n  GraphQLEntityField,\n  GraphQLJsonFieldType,\n  GraphQLJsonObjectType,\n  GraphQLModelsRelationsEnums,\n  GraphQLModelsType,\n  GraphQLRelationsType,\n  IndexType,\n} from './types';\n\nexport function getAllJsonObjects(_schema: GraphQLSchema | string): GraphQLObjectType[] {\n  return Object.values(getSchema(_schema).getTypeMap())\n    .filter((node) => node.astNode?.directives?.find(({name: {value}}) => value === DirectiveName.JsonField))\n    .map((node) => node)\n    .filter(isObjectType);\n}\n\nexport function getAllEnums(_schema: GraphQLSchema | string): GraphQLEnumType[] {\n  return getEnumsFromSchema(getSchema(_schema));\n}\n\n// eslint-disable-next-line complexity\nexport function getAllEntitiesRelations(_schema: GraphQLSchema | string): GraphQLModelsRelationsEnums {\n  const schema = getSchema(_schema);\n  const entities = Object.values(schema.getTypeMap())\n    .filter((node) => node.astNode?.directives?.find(({name: {value}}) => value === DirectiveName.Entity))\n    .filter(isObjectType);\n\n  const jsonObjects = getAllJsonObjects(schema);\n\n  const entityNameSet = entities.map((entity) => entity.name);\n\n  const enums = new Map(\n    getEnumsFromSchema(schema).map((node) => [\n      node.name,\n      {name: node.name, description: node.description, values: node.getValues().map((v) => v.value)},\n    ])\n  );\n\n  const modelRelations = {models: [], relations: [], enums: [...enums.values()]} as GraphQLModelsRelationsEnums;\n  const derivedFrom = schema.getDirective('derivedFrom');\n  const indexDirective = schema.getDirective('index');\n  for (const entity of entities) {\n    const newModel: GraphQLModelsType = {\n      name: entity.name,\n      description: entity.description,\n      fields: [],\n      indexes: [],\n    };\n\n    for (const field of Object.values(entity.getFields())) {\n      const typeString = extractType(field.type);\n      const derivedFromDirectValues = getDirectiveValues(derivedFrom, field.astNode);\n      const indexDirectiveVal = getDirectiveValues(indexDirective, field.astNode);\n      //If is a basic scalar type\n      const typeClass = getTypeByScalarName(typeString);\n      if (typeClass?.fieldScalar) {\n        newModel.fields.push(packEntityField(typeString, field, false));\n      }\n      // If is an enum\n      else if (enums.has(typeString)) {\n        newModel.fields.push({\n          type: typeString,\n          description: field.description,\n          isEnum: true,\n          isArray: isListType(isNonNullType(field.type) ? getNullableType(field.type) : field.type),\n          nullable: !isNonNullType(field.type),\n          name: field.name,\n        });\n      }\n      // If is a foreign key\n      else if (entityNameSet.includes(typeString) && !derivedFromDirectValues) {\n        newModel.fields.push(packEntityField(typeString, field, true));\n        modelRelations.relations.push({\n          from: entity.name,\n          type: 'belongsTo',\n          to: typeString,\n          foreignKey: `${field.name}Id`,\n        } as GraphQLRelationsType);\n        newModel.indexes.push({\n          unique: false,\n          fields: [`${field.name}Id`],\n          using: IndexType.HASH,\n        });\n      }\n      // If is derivedFrom\n      else if (entityNameSet.includes(typeString) && derivedFromDirectValues) {\n        modelRelations.relations.push({\n          from: entity.name,\n          type: isListType(isNonNullType(field.type) ? getNullableType(field.type) : field.type) ? 'hasMany' : 'hasOne',\n          to: typeString,\n          foreignKey: `${derivedFromDirectValues.field}Id`,\n          fieldName: field.name,\n        } as GraphQLRelationsType);\n      }\n      // If is jsonField\n      else if (jsonObjects.map((json) => json.name).includes(typeString)) {\n        const jsonObject = setJsonObjectType(\n          jsonObjects.find((object) => object.name === typeString),\n          jsonObjects\n        );\n        newModel.fields.push(packJSONField(typeString, field, jsonObject));\n        newModel.indexes.push({\n          unique: false,\n          fields: [field.name],\n          using: IndexType.GIN,\n        });\n      } else {\n        throw new Error(`${typeString} is not an valid type`);\n      }\n      // handle indexes\n      if (indexDirectiveVal) {\n        if (typeString !== 'ID' && typeClass) {\n          newModel.indexes.push({\n            unique: indexDirectiveVal.unique,\n            fields: [field.name],\n          });\n        } else if (typeString !== 'ID' && entityNameSet.includes(typeString)) {\n          if (indexDirectiveVal.unique) {\n            const fkIndex = newModel.indexes.find(\n              (idx) => idx.fields.length === 1 && idx.fields[0] === `${field.name}Id`\n            );\n            if (fkIndex) {\n              fkIndex.unique = true;\n            }\n          }\n        } else {\n          throw new Error(`index can not be added on field ${field.name}`);\n        }\n      }\n    }\n    modelRelations.models.push(newModel);\n  }\n  validateRelations(modelRelations);\n  return modelRelations;\n}\n\nfunction packEntityField(\n  typeString: FieldScalar | string,\n  field: GraphQLField<unknown, unknown>,\n  isForeignKey: boolean\n): GraphQLEntityField {\n  return {\n    name: isForeignKey ? `${field.name}Id` : field.name,\n    type: isForeignKey ? FieldScalar.String : typeString,\n    description: field.description,\n    isArray: isListType(isNonNullType(field.type) ? getNullableType(field.type) : field.type),\n    nullable: !isNonNullType(field.type),\n    isEnum: false,\n  };\n}\n\nfunction packJSONField(\n  typeString: string,\n  field: GraphQLField<unknown, unknown>,\n  jsonObject: GraphQLJsonObjectType\n): GraphQLEntityField {\n  return {\n    name: field.name,\n    type: 'Json',\n    description: field.description,\n    jsonInterface: jsonObject,\n    isArray: isListType(isNonNullType(field.type) ? getNullableType(field.type) : field.type),\n    nullable: !isNonNullType(field.type),\n    isEnum: false,\n  };\n}\n\nexport function setJsonObjectType(\n  jsonObject: GraphQLObjectType<unknown, unknown>,\n  jsonObjects: GraphQLObjectType<unknown, unknown>[]\n): GraphQLJsonObjectType {\n  const graphQLJsonObject: GraphQLJsonObjectType = {\n    name: jsonObject.name,\n    fields: [],\n  };\n  for (const field of Object.values(jsonObject.getFields())) {\n    //check if field is also json\n    const typeString = extractType(field.type);\n    const isJsonType = jsonObjects.map((json) => json.name).includes(typeString);\n    graphQLJsonObject.fields.push({\n      name: field.name,\n      type: isJsonType ? 'Json' : extractType(field.type),\n      jsonInterface: isJsonType\n        ? setJsonObjectType(\n            jsonObjects.find((object) => object.name === typeString),\n            jsonObjects\n          )\n        : undefined,\n      nullable: !isNonNullType(field.type),\n      isArray: isListType(isNonNullType(field.type) ? getNullableType(field.type) : field.type),\n    } as GraphQLJsonFieldType);\n  }\n  return graphQLJsonObject;\n}\n\nfunction getSchema(_schema: GraphQLSchema | string): GraphQLSchema {\n  return typeof _schema === 'string' ? buildSchemaFromFile(_schema) : _schema;\n}\n\nfunction getEnumsFromSchema(schema: GraphQLSchema): GraphQLEnumType[] {\n  return Object.values(schema.getTypeMap())\n    .filter((r) => r.astNode !== undefined)\n    .filter(isEnumType);\n}\n\n//Get the type, ready to be convert to string\nfunction extractType(type: GraphQLOutputType): string {\n  if (isUnionType(type)) {\n    throw new Error(`Not support Union type`);\n  }\n  if (isInterfaceType(type)) {\n    throw new Error(`Not support Interface type`);\n  }\n  const offNullType = isNonNullType(type) ? getNullableType(type) : type;\n  const offListType = isListType(offNullType) ? assertListType(offNullType).ofType : type;\n  return isNonNullType(offListType)\n    ? (getNullableType(offListType) as unknown as GraphQLNamedType).name\n    : offListType.name;\n}\n\nfunction validateRelations(modelRelations: GraphQLModelsRelationsEnums): void {\n  for (const r of modelRelations.relations.filter((model) => model.type === 'hasMany' || model.type === 'hasOne')) {\n    assert(\n      modelRelations.models.find(\n        (model) => model.name === r.to && model.fields.find((field) => field.name === r.foreignKey)\n      ),\n      `Please check entity ${r.from} with field ${r.fieldName} has correct relation with entity ${r.to}`\n    );\n  }\n}\n"]}